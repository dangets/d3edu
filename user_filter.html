<!DOCTYPE html>
<html>
    <head>
        <title>D3 experiment</title>
        <script type="text/javascript" src="http://mbostock.github.com/d3/d3.v2.js"></script>
        <!--
        <script type="text/javascript" src="d3/d3.v2.js"></script>
        -->
        <style type="text/css">
            #filter {
                float: left;
                overflow: auto;
            }

            #results {
                float: left;
                overflow: auto;
            }
        </style>
    </head>

    <body>
        <div>
            <div id="filter">
            </div>

            <div id="results">
            </div>
        </div>

        <script type="text/javascript">
            var totalWidth = window.innerWidth - 20;
            var totalHeight = window.innerHeight - 20;

            var filterWidth = totalWidth / 2 - 5;
            var resultsWidth = totalWidth / 2 - 5;

            var hist_width = 300;
            var hist_height = 80;

            var filterFrame = d3.select("#filter");
            filterFrame.style("width", filterWidth + "px");
            filterFrame.style("height", totalHeight + "px");

            var resultsFrame = d3.select("#results");
            resultsFrame.style("width", resultsWidth + "px");
            resultsFrame.style("height", totalHeight + "px");


            var numeric_fields = [
                "Total XP",
                "Quest XP",
                "Active",
                "Completed",
                "Dropped",
                "Reward XP",
                "Badges",
                "Achievements",
                "Awards",
                //"Activity",
                "Ratings",
                "Avg. Rating",
                "Avg. Time",
                "Comments",
            ]


            var userData = [];    // [UserObj, ...]
            var userMean;

            var histograms = new Object();
            var histogram_max_bins = 30;

            //var idVar = "GamerTag";

            function draw() {
                for (var i in numeric_fields) {
                    var fname = numeric_fields[i];

                    // update the histogram's scales' ranges
                    var x_scale = histograms[fname].value_scale;
                    x_scale.range([0, hist_width]);

                    var y_scale = histograms[fname].freq_scale;
                    y_scale.range([0, hist_width]);

                    var svg = d3.select("#filter")
                        .append("svg")
                        .attr("width", hist_width)
                        .attr("height", hist_height);

                    var bars = svg.selectAll(".bar")
                        .data(histograms[fname].values);

                    bars.enter()
                        .append("rect")
                        .attr("class", "bar")
                        .attr("x", function(d) { return x_scale(d.x); })
                        .attr("y", function(d) { return hist_height - y_scale(d.y); })
                        .attr("width", function(d) { return x_scale(d.dx) - 1; })
                        .attr("height", function(d) { return y_scale(d.y); });
                }

                //chart.select("#mean_line").remove();
                //chart.append("line")
                //    .attr("id", "mean_line")
                //    .attr("x1", 0)
                //    .attr("x2", visWidth)
                //    .attr("y1", visHeight - yScale(userMean[barVar]))
                //    .attr("y2", visHeight - yScale(userMean[barVar]))
                //    .attr("stroke", "#555")
                //    .attr("shape-rendering", "crispEdges");
            }


            /**
             * convert a single record with string values
             * into a user object with proper types
             */
            function createUserObj(namedRec) {
                var user = new Object();

                user["GamerTag"] = namedRec["GamerTag"];
                user["Name"] = namedRec["Name"];
                user["Last Initial"] = namedRec["Last Initial"];
                user["Rank/Grade"] = namedRec["Rank/Grade"];                 // ordinal field...
                user["Persistence"] = namedRec["Persistence"];
                user["Total XP"] = parseInt(namedRec["Total XP"]);
                user["Quest XP"] = parseInt(namedRec["Quest XP"]);
                user["Active"] = parseInt(namedRec["Active"]);
                user["Completed"] = parseInt(namedRec["Completed"]);
                user["Dropped"] = parseInt(namedRec["Dropped"]);
                user["Reward XP"] = parseInt(namedRec["Reward XP"]);
                user["Badges"] = parseInt(namedRec["Badges"]);
                user["Achievements"] = parseInt(namedRec["Achievements"]);
                user["Awards"] = parseInt(namedRec["Awards"]);
                user["Activity"] = parseInt(namedRec["Activity"]);
                user["Ratings"] = parseInt(namedRec["Ratings"]);
                user["Avg. Rating"] = parseFloat(namedRec["Avg. Rating"]);
                user["Avg. Time"] = parseFloat(namedRec["Avg. Time"]);
                user["Comments"] = parseInt(namedRec["Comments"]);

                for (var i=0; i<numeric_fields.length; ++i) {
                    var fname = numeric_fields[i];
                    if (isNaN(user[fname])) {
                        user[fname] = 0;
                    }
                }

                return user;
            }


            function preprocessUserData(data) {
                if (data == null) {
                    console.error("null data passed into preprocessUserData");
                    return null;
                }

                var newUserData = new Array();
                for (var i=0; i < data.length; i++) {
                    newUserData.push(createUserObj(data[i]));
                }

                return newUserData;
            }


            function getUserMean(data) {
                var user = new Object();
                for (var i in numeric_fields) {
                    var fname = numeric_fields[i];
                    user[fname] = d3.mean(data, function(d) { return d[fname]; });
                }

                return user;
            }


            function calculate_histograms(user_data, fields) {
                var hists = new Object();
                for (var i=0; i<fields.length; ++i) {
                    var fname = fields[i];

                    var min_val = d3.min(user_data, function(d) { return d[fname]; });
                    var max_val = d3.max(user_data, function(d) { return d[fname]; });
                    var num_bins = Math.min(histogram_max_bins, (max_val - min_val));

                    var value_scale = d3.scale.linear().domain([min_val, max_val]);

                    var histogram = d3.layout.histogram()
                        .bins(value_scale.ticks(num_bins))
                        .value(function(d) { return d[fname]; });

                    var values = histogram(user_data);

                    var freq_scale = d3.scale.linear()
                        .domain([0, d3.max(values, function(d) { return d.y; })]);

                    hists[fname] = new Object();
                    hists[fname].min_val = min_val;
                    hists[fname].max_val = max_val;
                    hists[fname].num_bins = num_bins;
                    hists[fname].value_scale = value_scale;
                    hists[fname].freq_scale = freq_scale;
                    hists[fname].histogram_func = histogram;
                    hists[fname].values = values;
                    // NOTE: still need to set the value and freq scale ranges!
                }

                return hists;
            }


            var fname = "user_report.csv";
            d3.csv(fname, function(data) {
                userData = preprocessUserData(data);
                histograms = calculate_histograms(userData, numeric_fields);
                userMean = getUserMean(userData);

                draw();
            });

        </script>
    </body>
</html>


